extends layout

block vars
    - title = t('pages.profile.title')

block head
    link(rel='stylesheet', type='text/css', href='https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css')
    script(src='https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js')

block content
    .container(ng-controller='profileCtrl')
        form#profile-form
            .row
                .form-group.col-xs-12.col-sm-12
                    label.control-label(ng-class='{ "active": p.slogan.edit }')= t('pages.profile.slogan')
                    input#slogan.form-control(type='text', placeholder=t('pages.profile.slogan-ph'), value=profile.get('slogan.value'), data-value=profile.get('slogan.value'), data-id=profile.get('slogan.id'), ng-focus='p.slogan.edit = true', ng-blur='p.slogan.edit = false')

                .form-group.col-xs-12.col-sm-3
                    label.control-label(ng-class='{ "active": p.forename.edit }')= t('pages.profile.forename')
                    input#forename.form-control(type='text', placeholder=t('pages.profile.forename-ph'), value=profile.get('forename.value'), data-value=profile.get('forename.value'), data-id=profile.get('forename.id'), ng-focus='p.forename.edit = true', ng-blur='p.forename.edit = false')

                .form-group.col-xs-12.col-sm-3
                    label.control-label(ng-class='{ "active": p.surname.edit }')= t('pages.profile.surname')
                    input#surname.form-control(type='text', placeholder=t('pages.profile.surname-ph'), value=profile.get('surname.value'), data-value=profile.get('surname.value'), data-id=profile.get('surname.id'), ng-focus='p.surname.edit = true', ng-blur='p.surname.edit = false')

                .form-group.col-xs-12.col-sm-3
                    label.control-label(ng-class='{ "active": p.email.edit }')= t('pages.profile.email')
                    input#email.form-control(type='text', placeholder=t('pages.profile.email-ph'), value=profile.get('email.value'), data-value=profile.get('email.value'), data-id=profile.get('email.id'), ng-focus='p.email.edit = true', ng-blur='p.email.edit = false')

                .form-group.col-xs-12.col-sm-3
                    label.control-label(ng-class='{ "active": p.language.edit }')= t('pages.profile.language')
                    select#language.form-control(data-value=profile.get('language.value'), data-id=profile.get('language.id'), ng-focus='p.language.edit = true', ng-blur='p.language.edit = false')
                        if !profile.get('language.value')
                            option()
                        each l in locales
                            option(selected=profile.get('language.value') == l, value=l)= t('locales.' + l)

                .form-group.col-xs-12
                    label.control-label(for='photo')= t('pages.profile.photo')
                    if !profile.get('photo')
                        input.form-control(ng-show='!photo_upload', type='file', custom-on-change='photoUpload')
                        small(ng-show='photo_upload')= t('pages.profile.photo-upload')
                    else
                        .row
                            .col-xs-2
                                .row
                                    img.col-xs-12(src=profile.get('photo.file'), alt=profile.get('photo.value'))
                                    a.btn.col-xs-12.text-left(ng-click='photoDelete(#{ profile.get("photo.id") })')= t('pages.profile.delete-photo')

            .row.spacer
            .row.spacer

                .form-group.col-xs-12.col-sm-4
                    label.control-label(ng-class='{ "active": p.address.edit }')= t('pages.profile.address')
                    input#address.form-control(type='text', placeholder=t('pages.profile.address-ph'), value=profile.get('address.value'), data-value=profile.get('address.value'), data-id=profile.get('address.id'), ng-focus='p.address.edit = true', ng-blur='p.address.edit = false')
                .form-group.col-xs-12.col-sm-4
                    label.control-label(ng-class='{ "active": p.town.edit }')= t('pages.profile.city')
                    input#town.form-control(type='text', placeholder=t('pages.profile.city-ph'), value=profile.get('town.value'), data-value=profile.get('town.value'), data-id=profile.get('town.id'), ng-focus='p.town.edit = true', ng-blur='p.town.edit = false')

                .form-group.col-xs-12.col-sm-4
                    label.control-label(ng-class='{ "active": p.county.edit }')= t('pages.profile.county')
                    input#county.form-control(type='text', placeholder=t('pages.profile.county-ph'), value=profile.get('county.value'), data-value=profile.get('county.value'), data-id=profile.get('county.id'), ng-focus='p.county.edit = true', ng-blur='p.county.edit = false')

                .form-group.col-xs-12.col-sm-4
                    label.control-label(ng-class='{ "active": p.country.edit }')= t('pages.profile.country')
                    input#country.form-control(type='text', placeholder=t('pages.profile.country-ph'), value=profile.get('country.value'), data-value=profile.get('country.value'), data-id=profile.get('country.id'), ng-focus='p.country.edit = true', ng-blur='p.country.edit = false')


            .row.spacer
            .row.spacer

            .row
                .col-xs-12
                    a.profile-tab.col-xs-4.bg-green(ng-click='tab = 1', ng-class='{ "active": tab === 1 }')= t('pages.profile.me-help-you-tab')
                    a.profile-tab.active.col-xs-4.bg-red(ng-click='tab = 2', ng-class='{ "active": !tab || tab === 2 }')= t('pages.profile.about-me-tab')
                    a.profile-tab.col-xs-4.bg-yellow(ng-click='tab = 3', ng-class='{ "active": tab === 3 }')= t('pages.profile.you-help-me-tab')

            .row
                .profile-tab-pane(ng-show='tab === 1')
                    .form-group.col-xs-12
                        label.control-label(for='me-help-you-text')= t('pages.profile.me-help-you-text')
                        textarea#me-help-you-text.form-control(data-value=profile.get('me-help-you-text.value'), data-id=profile.get('me-help-you-text.id'), rows=8)= profile.get('me-help-you-text.value')
                        p.text-right
                            small!= t('pages.profile.markdown-info')

                    //- .form-group.col-xs-12.col-sm-4
                    //-     label.control-label(for='me-help-you-photo') Cover Photo
                    //-     input#me-help-you-photo.form-control(type='file')

                    .form-group.col-xs-12.col-sm-8
                        label.control-label(ng-class='{ "active": p.me_help_video.edit }')= t('pages.profile.me-help-you-video')
                        input#me-help-you-video.form-control(type='text', placeholder=t('pages.profile.video-ph'), value=profile.get('me-help-you-video.value'), data-value=profile.get('me-help-you-video.value'), data-id=profile.get('me-help-you-video.id'), ng-focus='p.me_help_video.edit = true', ng-blur='p.me_help_video.edit = false')
                        p.text-right
                            small!= t('pages.profile.video-info')

                .profile-tab-pane(ng-show='!tab || tab === 2')
                    .form-group.col-xs-12
                        label.control-label(for='about-me-text')= t('pages.profile.about-me-text')
                        textarea#about-me-text.form-control(data-value=profile.get('about-me-text.value'), data-id=profile.get('about-me-text.id'), rows=8)= profile.get('about-me-text.value')
                        p.text-right
                            small!= t('pages.profile.markdown-info')

                    //- .form-group.col-xs-12.col-sm-4
                    //-     label.control-label(for='about-me-photo') Cover Photo
                    //-     input#about-me-photo.form-control(type='file')

                    .form-group.col-xs-12.col-sm-8
                        label.control-label(ng-class='{ "active": p.about_video.edit }')= t('pages.profile.about-me-video')
                        input#about-me-video.form-control(type='text', placeholder=t('pages.profile.video-ph'), value=profile.get('about-me-video.value'), data-value=profile.get('about-me-video.value'), data-id=profile.get('about-me-video.id'), ng-focus='p.about_video.edit = true', ng-blur='p.about_video.edit = false')
                        p.text-right
                            small!= t('pages.profile.video-info')

                .profile-tab-pane(ng-show='tab === 3')
                    .form-group.col-xs-12
                        label.control-label(for='you-help-me-text')= t('pages.profile.you-help-me-text')
                        textarea#you-help-me-text.form-control(data-value=profile.get('you-help-me-text.value'), data-id=profile.get('you-help-me-text.id'), rows=8)= profile.get('you-help-me-text.value')
                        p.text-right
                            small!= t('pages.profile.markdown-info')

                    //- .form-group.col-xs-12.col-sm-4
                    //-     label.control-label(for='you-help-me-photo') Cover Photo
                    //-     input#you-help-me-photo.form-control(type='file')

                    .form-group.col-xs-12.col-sm-8
                        label.control-label(ng-class='{ "active": p.you_help_video.edit }')= t('pages.profile.you-help-me-video')
                        input#you-help-me-video.form-control(type='text', placeholder=t('pages.profile.video-ph'), value=profile.get('you-help-me-video.value'), data-value=profile.get('you-help-me-video.value'), data-id=profile.get('you-help-me-video.id'), ng-focus='p.you_help_video.edit = true', ng-blur='p.you_help_video.edit = false')
                        p.text-right
                            small!= t('pages.profile.video-info')

            .row.spacer

    script.
        var md = {}
        $('textarea').each(function() {
            var input = $(this)
            var id = input.attr('id')
            md[id] = new SimpleMDE({
                element: document.getElementById(id),
                status: false,
                spellChecker: false
            })
            md[id].render()
            md[id].codemirror.on('focus', function() {
                $("label[for='" + id + "']").addClass('active')
                $('.CodeMirror').addClass('CodeMirror-focus')
            })
            md[id].codemirror.on('blur', function() {
                $("label[for='" + id + "']").removeClass('active')
                $('.CodeMirror').removeClass('CodeMirror-focus')
                var value = md[id].value()
                if(input.data('value') !=value) {
                    var postdata = {
                        property: input.attr('id'),
                        id: input.data('id'),
                        value: value
                    }
                    $.post('', postdata, function(data) {
                        input.val(data.value)
                        input.data('id', data.id)
                        input.data('value', data.value)
                    }).fail(console.log)
                }
            })
        })

        $('input').blur(function() {
            input = $(this)
            if(input.data('value') != input.val()) {
                var postdata = {
                    property: input.attr('id'),
                    id: input.data('id'),
                    value: input.val()
                }
                $.post('', postdata, function(data) {
                    input.val(data.value)
                    input.data('id', data.id)
                    input.data('value', data.value)
                }).fail(console.log)
            }
        })

        $('select').change(function() {
            input = $(this)
            var postdata = {
                property: input.attr('id'),
                id: input.data('id'),
                value: input.val()
            }
            $.post('', postdata, function(data) {
                input.val(data.value)
                input.data('id', data.id)
                input.data('value', data.value)

                location.href = '/' + data.value + '#{ path.substring(3) }'
            }).fail(console.log)
        })
