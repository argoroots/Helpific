extends layout

block vars
    - title = t('pages.help.' + help_type + '-title')

block head
    script(src='/javascripts/date-et-EE.js')

block content
    .container(ng-controller='helpCtrl')
        #search.row
            form.form-group.col-xs-10.col-sm-8.col-md-6.col-xs-offset-1.col-sm-offset-2.col-md-offset-3
                label.col-xs-1(for='search-input')
                    i.fa.fa-search
                input#search-input.col-xs-10.text-center(type='search', placeholder='', ng-model='search_query' autofocus)

            .col-xs-12.text-center(ng-if='!help && search_query')
                i.fa.fa-spinner.fa-pulse.fa-2x

            small.col-xs-12.text-center(ng-if='help')!= t('pages.help.' + help_type + '-count')

        if show_add
            .row.spacer

            .row
                .col-xs-12.text-right
                    a#request-add.btn.bg-red(href='javascript:void(0)')= t('pages.help.add-new-' + help_type)
            form#help-form.help-form.hidden
                .row
                    .form-group.col-xs-12.col-sm-3
                        label.control-label(for='time')= t('pages.help.time')
                        input#time.form-control(type='text', placeholder=t('pages.help.time-ph'))

                    .form-group.col-xs-12.col-sm-3
                        label.control-label(for='location')= t('pages.help.location')
                        input#location.form-control(type='text', placeholder=t('pages.help.location-ph'))

                    .form-group.col-xs-12.col-sm-5
                        label.control-label(for='request')= t('pages.help.' + help_type + '-request')
                        input#request.form-control(type='text', placeholder=t('pages.help.' + help_type + '-request-ph'))
                    .form-group.col-xs-12.col-sm-1.text-right
                        label.control-label(for='request') &nbsp;
                        a#request-save.btn.bg-red.text-center(href='javascript:void(0)')= t('pages.help.save')
                        i#request-spinner.hidden.fa.fa-cog.fa-spin.fa-2x

        .row(ng-repeat-start='s in statuses')
            h2.col-xs-12(ng-if='(help | filter:{status:s.status, type:type} | filter:search_query).length > 0') {{ s.label }}

        .table(ng-if='(help | filter:{status:s.status, type:type} | filter:search_query).length > 0')
            .row(ng-repeat='h in help | filter:{status:s.status, type:type} | filter:search_query | orderBy:["-time", "-id"]', ng-class='h.editing ? "bg-green-transparent" : ""')

                div(ng-show='!h.editing')
                    a(ng-href='help/{{ h.type }}/{{ h.id }}')
                        img.col-xs-2.col-md-1.img-circle(ng-src='{{ h.picture }}', alt='{{ h.person }}')
                    .col.col-xs-10.col-sm-3.col-md-3
                        a(ng-href='help/{{ h.type }}/{{ h.id }}') {{ h.person }}
                        div {{ h.time_formatted }}
                        em {{ h.location }}
                    .col.col-xs-12.col-sm-6.col-md-7 {{ h.request }}
                    a.col.col-xs-12.col-sm-1.text-center(ng-if='h.person_id != #{ user.id }', ng-href='messages/{{ h.person_id }}')= t('pages.help.reply')
                    a.col.col-xs-12.col-sm-1.text-center(ng-if='h.person_id == #{ user.id }', ng-click='h.editing = true')= t('pages.help.edit')

                form.help-form(ng-show='h.editing')
                    .form-group.col-xs-12.col-sm-2
                        label.control-label(for='time')= t('pages.help.time')
                        input.form-control(type='text', placeholder=t('pages.help.time-ph'), ng-model='h.time_formatted')
                    .form-group.col-xs-12.col-sm-2
                        label.control-label(for='location')= t('pages.help.location')
                        input.form-control(type='text', placeholder=t('pages.help.location-ph'), ng-model='h.location')
                    .form-group.col-xs-12.col-sm-6
                        label.control-label(for='request')= t('pages.help.' + help_type + '-request')
                        input.form-control(type='text', placeholder=t('pages.help.' + help_type + '-request-ph'), ng-model='h.request')
                    .form-group.col-xs-12.col-sm-2
                        label.control-label(for='location')= t('pages.help.status')
                        select.form-control(ng-options='s.status as s.label for s in statuses', ng-model='h.status')
                    .form-group.col-xs-10.col-sm-2.pull-right.text-right
                        label.control-label
                        a#request-save.btn.bg-red.col-xs-12.text-center(href='javascript:void(0)')= t('pages.help.save')
                        i#request-spinner.hidden.fa.fa-cog.fa-spin.fa-2x
                    .form-group.col-xs-2.pull-right.text-right
                        label.control-label
                        a#request-save.btn.btn-link.text-right(ng-click='h.editing = false')= t('pages.help.cancel')

        div(ng-repeat-end)

        .row.spacer

    script.
        $('input').focus(function() {
            $("label[for='" + this.id + "']").addClass('labelfocus')
        }).blur(function() {
            $('label').removeClass('labelfocus')
        })

        $('#time').change(function() {
            var d = Date.parse($(this).val())
            if(d) {
                $(this).val(d.toString('dd.MM.yyyy HH:mm').replace(' 00:00', ''))
            } else {
                $(this).val('')
            }
        })

        $('#request-add').click(function() {
            $('#request-add').addClass('hidden')
            $('#help-form').removeClass('hidden')
        })

        $('#request-save').click(function() {
            if($('#request').val()) {
                $('#request-save').addClass('hidden')
                $('#request-spinner').removeClass('hidden')
                var postdata = {
                    'type': '#{ help_type }',
                    'time': $('#time').val(),
                    'location': $('#location').val(),
                    'request': $('#request').val()
                }
                $.post('', postdata, function(data) {
                    setTimeout(function() {
                        location.reload(true)
                    }, 1500)
                }).fail(
                    setTimeout(function() {
                        location.reload(true)
                    }, 1500)
                )
            } else {
                $('#request').focus()
            }
        })
