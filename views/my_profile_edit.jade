extends layout

block head
    link(rel='stylesheet', type='text/css', href='https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css')
    script(src='https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js')

block vars
    - title='My profile'

block content
    .container
        form#profile
            .row
                .form-group.col-xs-12.col-sm-12
                    label.control-label(for='slogan') Slogan
                    input.form-control(id='slogan', type='text', placeholder='', value=profile.get('slogan.value'), data-value=profile.get('slogan.value'), data-id=profile.get('slogan.id'))

                .form-group.col-xs-12.col-sm-3
                    label.control-label(for='forename') Forename
                    input.form-control(id='forename', type='text', placeholder='e.g. John', value=profile.get('forename.value'), data-value=profile.get('forename.value'), data-id=profile.get('forename.id'))

                .form-group.col-xs-12.col-sm-3
                    label.control-label(for='surname') Surname
                    input.form-control(id='surname', type='text', placeholder='e.g. Appleseed', value=profile.get('surname.value'), data-value=profile.get('surname.value'), data-id=profile.get('surname.id'))

                .form-group.col-xs-12.col-sm-3
                    label.control-label(for='email') E-mail
                    input.form-control(id='email', type='text', placeholder='e.g. john@appleseed.com', value=profile.get('email.value'), data-value=profile.get('email.value'), data-id=profile.get('email.id'))

                //- .form-group.col-xs-12.col-sm-3
                //-     label.control-label(for='you_help_photo') Profile Picture
                //-     input.form-control(id='you_help_photo', type='file')

            .row.spacer
            .row.spacer

                .form-group.col-xs-12.col-sm-4
                    label.control-label(for='address') Address
                    input.form-control(id='address', type='text', placeholder='e.g. Tartu mnt. 1', value=profile.get('address.value'), data-value=profile.get('address.value'), data-id=profile.get('address.id'))
                .form-group.col-xs-12.col-sm-4
                    label.control-label(for='town') City
                    input.form-control(id='town', type='text', placeholder='e.g. Tallinn', value=profile.get('town.value'), data-value=profile.get('town.value'), data-id=profile.get('town.id'))

                .form-group.col-xs-12.col-sm-4
                    label.control-label(for='county') County
                    input.form-control(id='county', type='text', placeholder='e.g. Harjumaa', value=profile.get('county.value'), data-value=profile.get('county.value'), data-id=profile.get('county.id'))

                .form-group.col-xs-12.col-sm-4
                    label.control-label(for='country') Country
                    input.form-control(id='country', type='text', placeholder='e.g. Estonia', value=profile.get('country.value'), data-value=profile.get('country.value'), data-id=profile.get('country.id'))


            .row.spacer
            .row.spacer

            .row
                .col-xs-12
                    a.profile-tab.col-xs-4.bg-green(href='javascript:void(0)', data-tab='me-help-you-tab') I can help others
                    a.profile-tab.profile-tab-active.col-xs-4.bg-red(href='javascript:void(0)', data-tab='about-me-tab') About me
                    a.profile-tab.col-xs-4.bg-yellow(href='javascript:void(0)', data-tab='you-help-me-tab') I need help

            .row
                #me-help-you-tab.profile-tab-pane
                    .form-group.col-xs-12
                        label.control-label(for='me-help-you-text') How you can help others?
                        textarea.form-control(id='me-help-you-text', data-value=profile.get('me-help-you-text.value'), data-id=profile.get('me-help-you-text.id'), rows=8)= profile.get('me-help-you-text.value')
                        p.text-right
                            small use&nbsp;
                                a(href='https://en.wikipedia.org/wiki/Markdown#Example', target='_blank') markdown
                                |  for styling your text

                    //- .form-group.col-xs-12.col-sm-4
                    //-     label.control-label(for='me-help-you-photo') Cover Photo
                    //-     input.form-control(id='me-help-you-photo', type='file')

                    .form-group.col-xs-12.col-sm-8
                        label.control-label(for='me-help-you-video') Video URL
                        input.form-control(id='me-help-you-video', type='text', placeholder='e.g. https://www.youtube.com/watch?v=QH2-TGUlwu4', value=profile.get('me-help-you-video.value'), data-value=profile.get('me-help-you-video.value'), data-id=profile.get('me-help-you-video.id'))
                        p.text-right
                            small
                                | we support only&nbsp;
                                a(href='https://youtube.com', target='_blank') YouTube
                                | ,&nbsp;
                                a(href='https://vimeo.com', target='_blank') Vimeo
                                |  and&nbsp;
                                a(href='https://wistia.com', target='_blank') Wistia
                                |  urls

                #about-me-tab.profile-tab-pane
                    .form-group.col-xs-12
                        label.control-label(for='about-me-text') Write something about you
                        textarea.form-control(id='about-me-text', data-value=profile.get('about-me-text.value'), data-id=profile.get('about-me-text.id'), rows=8)= profile.get('about-me-text.value')
                        p.text-right
                            small use&nbsp;
                                a(href='https://en.wikipedia.org/wiki/Markdown#Example', target='_blank') markdown
                                |  for styling your text

                    //- .form-group.col-xs-12.col-sm-4
                    //-     label.control-label(for='about-me-photo') Cover Photo
                    //-     input.form-control(id='about-me-photo', type='file')

                    .form-group.col-xs-12.col-sm-8
                        label.control-label(for='about-me-video') Video URL
                        input.form-control(id='about-me-video', type='text', placeholder='e.g. https://www.youtube.com/watch?v=QH2-TGUlwu4', value=profile.get('about-me-video.value'), data-value=profile.get('about-me-video.value'), data-id=profile.get('about-me-video.id'))
                        p.text-right
                            small
                                | we support only&nbsp;
                                a(href='https://youtube.com', target='_blank') YouTube
                                | ,&nbsp;
                                a(href='https://vimeo.com', target='_blank') Vimeo
                                |  and&nbsp;
                                a(href='https://wistia.com', target='_blank') Wistia
                                |  urls

                #you-help-me-tab.profile-tab-pane
                    .form-group.col-xs-12
                        label.control-label(for='you-help-me-text') What kind of help you need?
                        textarea.form-control(id='you-help-me-text', data-value=profile.get('you-help-me-text.value'), data-id=profile.get('you-help-me-text.id'), rows=8)= profile.get('you-help-me-text.value')
                        p.text-right
                            small use&nbsp;
                                a(href='https://en.wikipedia.org/wiki/Markdown#Example', target='_blank') markdown
                                |  for styling your text

                    //- .form-group.col-xs-12.col-sm-4
                    //-     label.control-label(for='you-help-me-photo') Cover Photo
                    //-     input.form-control(id='you-help-me-photo', type='file')

                    .form-group.col-xs-12.col-sm-8
                        label.control-label(for='you-help-me-video') Video URL
                        input.form-control(id='you-help-me-video', type='text', placeholder='e.g. https://www.youtube.com/watch?v=QH2-TGUlwu4', value=profile.get('you-help-me-video.value'), data-value=profile.get('you-help-me-video.value'), data-id=profile.get('you-help-me-video.id'))
                        p.text-right
                            small
                                | we support only&nbsp;
                                a(href='https://youtube.com', target='_blank') YouTube
                                | ,&nbsp;
                                a(href='https://vimeo.com', target='_blank') Vimeo
                                |  and&nbsp;
                                a(href='https://wistia.com', target='_blank') Wistia
                                |  urls

            .row.spacer

    script.
        setTimeout(function() {
            $('#me-help-you-tab').addClass('hidden')
            $('#you-help-me-tab').addClass('hidden')
        }, 100)

        $('.profile-tab').click(function() {
            $('.profile-tab').removeClass('profile-tab-active')
            $(this).addClass('profile-tab-active')

            $('.profile-tab-pane').addClass('hidden')
            $('#' + $(this).data('tab')).removeClass('hidden')
        })


        var md = {}
        $('textarea').each(function() {
            var input = $(this)
            var id = input.attr('id')
            md[id] = new SimpleMDE({
                element: document.getElementById(id),
                status: false,
                spellChecker: false
            })
            md[id].render()
            md[id].codemirror.on('focus', function() {
                $("label[for='" + id + "']").addClass('labelfocus')
                $('.CodeMirror').addClass('CodeMirror-focus')
            })
            md[id].codemirror.on('blur', function() {
                $("label[for='" + id + "']").removeClass('labelfocus')
                $('.CodeMirror').removeClass('CodeMirror-focus')
                var value = md[id].value()
                if(input.data('value') !=value) {
                    var postdata = {
                        property: input.attr('id'),
                        id: input.data('id'),
                        value: value
                    }
                    $.post('', postdata, function(data) {
                        input.val(data.value)
                        input.data('id', data.id)
                        input.data('value', data.value)
                    }).fail(console.log)
                }
            })
        })

        $('input').focus(function() {
            $("label[for='" + this.id + "']").addClass('labelfocus')
        }).blur(function() {
            $('label').removeClass('labelfocus')

            input = $(this)
            if(input.data('value') != input.val()) {
                var postdata = {
                    property: input.attr('id'),
                    id: input.data('id'),
                    value: input.val()
                }
                $.post('', postdata, function(data) {
                    input.val(data.value)
                    input.data('id', data.id)
                    input.data('value', data.value)
                }).fail(console.log)
            }
        })
